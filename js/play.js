const PresentationMode={init(){this.isActive=false;this.currentElementIndex=0;this.elements=[];this.isPlaying=false;this.playInterval=null;this.canvas=null;this.ctx=null;this.isDrawing=false;this.autoScroll=true;this.currentPageId=typeof currentPageIdIframe!=='undefined'?currentPageIdIframe:null;this.typingSpeed=50;this.currentTypingIndex=0;this.isTyping=false;this.eraserMode=false;this.lastInteraction=Date.now();this.uiTimeout=null;this.isUIHidden=false;this.mainButtonTimeout=null;this.isMainButtonHidden=false;this.isBlankPage=false;this.isSpeaking=false;this.speechSynthesis=window.speechSynthesis;this.currentSpeech=null;this.timerStart=null;this.timerInterval=null;this.timerElapsed=0;this.timerState='stopped';this.isNotesOpen=false;this.isLaserActive=false;this.pageStates={};if(typeof pagesDataIframe==='undefined'){setTimeout(()=>this.init(),1000);return}this.createPresentationButton()},createPresentationButton(){const button=document.createElement('button');button.id='presentationModeBtn';button.innerHTML='<i class="fas fa-play-circle"></i>';button.setAttribute('aria-label','Start Presentation Mode (P)');button.style.cssText='position:fixed;top:5rem;right:1.5rem;background-color:#BB86FC;color:#000000;width:3rem;height:3rem;border-radius:50%;display:flex;justify-content:center;align-items:center;font-size:1.5rem;cursor:pointer;box-shadow:0 2px 10px rgba(0,0,0,0.3);border:none;z-index:1000;transition:all 0.3s ease;opacity:1;';button.addEventListener('mouseenter',()=>{this.resetMainButtonTimer();button.style.transform='scale(1.1)';});button.addEventListener('mouseleave',()=>button.style.transform='scale(1)');button.addEventListener('click',()=>{this.resetMainButtonTimer();this.togglePresentationMode();});button.addEventListener('keydown',(e)=>{if(e.key==='Enter'||e.key===' '){e.preventDefault();this.resetMainButtonTimer();this.togglePresentationMode();}});document.body.appendChild(button);this.setupMainButtonAutoHide();this.setupGlobalKeyboardShortcuts()},togglePresentationMode(){if(this.isActive){this.exitPresentationMode()}else{this.enterPresentationMode()}},enterPresentationMode(){if(!this.currentPageId){return}this.isActive=true;this.currentPageId=currentPageIdIframe;document.body.style.overflow='hidden';document.body.setAttribute('aria-hidden','true');this.createPresentationContainer();this.setupCanvas();this.loadPageState();this.extractElements();this.createBottomBar();this.startPresentation();this.setupTimerButton();this.setupPresentationKeyboardShortcuts();document.getElementById('presentationModeBtn').style.display='none';document.getElementById('presentationContainer').focus()},exitPresentationMode(){this.savePageState();this.isActive=false;this.isPlaying=false;this.isTyping=false;this.isBlankPage=false;this.isSpeaking=false;this.isNotesOpen=false;this.isLaserActive=false;if(this.playInterval)clearInterval(this.playInterval);if(this.uiTimeout)clearTimeout(this.uiTimeout);if(this.timerInterval)clearInterval(this.timerInterval);if(this.currentSpeech)this.speechSynthesis.cancel();document.body.style.overflow='';document.body.removeAttribute('aria-hidden');const container=document.getElementById('presentationContainer');if(container)container.remove();const minimizedBtn=document.getElementById('minimizedControlBtn');if(minimizedBtn)minimizedBtn.remove();document.getElementById('presentationModeBtn').style.display='flex';document.getElementById('presentationModeBtn').focus();this.resetMainButtonTimer();window.removeEventListener('resize',this.resizeCanvas);document.removeEventListener('mousemove',this.resetUITimer);document.removeEventListener('click',this.resetUITimer);document.removeEventListener('keydown',this.resetUITimer);document.removeEventListener('touchstart',this.resetUITimer);if(this.canvas){this.canvas.removeEventListener('mousemove',this.handleLaser);this.canvas.removeEventListener('touchmove',this.handleLaserTouch);this.canvas.removeEventListener('touchcancel',this.handleLaserTouch)}},createPresentationContainer(){const container=document.createElement('div');container.id='presentationContainer';container.setAttribute('role','dialog');container.setAttribute('aria-label','Presentation Mode');container.setAttribute('tabindex','-1');container.style.cssText='position:fixed;top:0;left:0;width:100vw;height:100vh;background-color:#1a1a1a;z-index:10000;display:flex;flex-direction:column;';const contentArea=document.createElement('div');contentArea.id='presentationContent';contentArea.setAttribute('role','main');contentArea.style.cssText='flex:1;overflow-y:auto;overflow-x:hidden;padding:2rem;position:relative;max-height:calc(100vh - 4rem);';const canvasContainer=document.createElement('div');canvasContainer.id='canvasContainer';canvasContainer.style.cssText='position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:1;';contentArea.appendChild(canvasContainer);container.appendChild(contentArea);document.body.appendChild(container);container.addEventListener('keydown',(e)=>{if(e.key==='Escape'){this.exitPresentationMode()}})},setupCanvas(){this.canvas=document.createElement('canvas');this.canvas.setAttribute('aria-label','Drawing Canvas');this.canvas.style.cssText='position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:2;';this.ctx=this.canvas.getContext('2d');this.ctx.strokeStyle='#BB86FC';this.ctx.lineWidth=3;this.ctx.lineCap='round';this.resizeCanvas();window.addEventListener('resize',()=>this.resizeCanvas());this.setupDrawingEvents();this.setupUIAutoHide();document.getElementById('canvasContainer').appendChild(this.canvas)},resizeCanvas(){const container=document.getElementById('presentationContent');if(!container)return;this.canvas.width=container.offsetWidth*window.devicePixelRatio;this.canvas.height=container.scrollHeight*window.devicePixelRatio;this.canvas.style.width=container.offsetWidth+'px';this.canvas.style.height=container.scrollHeight+'px';this.ctx.scale(window.devicePixelRatio,window.devicePixelRatio);this.ctx.strokeStyle='#BB86FC'},setupDrawingEvents(){let lastX=0,lastY=0;const getCoords=(e,isTouch=false)=>{if(!e||!this.canvas)return[0,0];const rect=this.canvas.getBoundingClientRect();if(isTouch&&e.touches&&e.touches[0])return[e.touches[0].clientX-rect.left,e.touches[0].clientY-rect.top];return[e.offsetX,e.offsetY]};const clearArea=(x,y,radius=20)=>{this.ctx.clearRect(x-radius,y-radius,radius*2,radius*2)};const startDrawing=(e,isTouch=false)=>{this.resetUITimer();const[x,y]=getCoords(e,isTouch);if(this.eraserMode){clearArea(x,y)}else if(!this.isLaserActive){this.isDrawing=true}[lastX,lastY]=[x,y];if(isTouch)e.preventDefault()};const moveDrawing=(e,isTouch=false)=>{this.resetUITimer();const[x,y]=getCoords(e,isTouch);if(this.eraserMode){clearArea(x,y)}else if(this.isDrawing&&!this.isLaserActive){this.ctx.beginPath();this.ctx.moveTo(lastX,lastY);this.ctx.lineTo(x,y);this.ctx.stroke();[lastX,lastY]=[x,y]}if(isTouch)e.preventDefault()};this.canvas.addEventListener('mousedown',(e)=>startDrawing(e));this.canvas.addEventListener('mousemove',(e)=>moveDrawing(e));this.canvas.addEventListener('mouseup',()=>{this.isDrawing=false});this.canvas.addEventListener('mouseout',()=>{this.isDrawing=false});this.canvas.addEventListener('touchstart',(e)=>startDrawing(e,true));this.canvas.addEventListener('touchmove',(e)=>moveDrawing(e,true));this.canvas.addEventListener('touchend',()=>{this.isDrawing=false});this.canvas.addEventListener('touchcancel',()=>{this.isDrawing=false})},extractElements(){const page=pagesDataIframe.find(p=>p.id===this.currentPageId);if(!page){return}const tempDiv=document.createElement('div');tempDiv.innerHTML=page.content;const qaBlocks=tempDiv.querySelectorAll('.qa-block');qaBlocks.forEach(block=>{const parent=block.parentNode;if(parent&&parent!==tempDiv){tempDiv.appendChild(block.cloneNode(true));block.remove()}});this.elements=Array.from(tempDiv.children).filter(el=>{const tagName=el.tagName.toLowerCase();return['h1','h2','h3','p','ul','ol','table','pre','img','iframe','strong','em','a','div','blockquote','code'].includes(tagName)}).map(el=>{if(el.tagName==='A'){const href=el.getAttribute('href');if(href&&href.length>50){el.textContent=href.substring(0,47)+'...'}}if(el.tagName==='IMG'){el.style.maxWidth='80%';el.style.height='auto';el.style.maxHeight='400px';el.style.objectFit='contain';el.style.display='block';el.style.margin='0 auto 1rem auto'}if(el.tagName==='IFRAME'){el.style.width='80%';el.style.height='300px';el.style.maxHeight='400px';el.style.display='block';el.style.margin='0 auto 1rem auto'}if(el.tagName==='UL'||el.tagName==='OL'){el.style.margin='0 0 1rem 1.25rem';el.style.padding='0';Array.from(el.children).forEach(li=>{li.style.marginBottom='0.5rem';li.style.paddingLeft='0.5rem'})}return el.outerHTML});this.currentElementIndex=this.pageStates[this.currentPageId]?.elementIndex||0},createBottomBar(){const bottomBar=document.createElement('div');bottomBar.id='presentationBottomBar';bottomBar.setAttribute('role','toolbar');bottomBar.style.cssText='height:4rem;background-color:#0a0a0a;border-top:2px solid #BB86FC;display:flex;align-items:center;padding:0 1rem;flex-shrink:0;overflow-x:auto;overflow-y:hidden;gap:1rem;';const scrollContainer=document.createElement('div');scrollContainer.style.cssText='display:flex;align-items:center;gap:1rem;min-width:max-content;padding:0 1rem;';const prevBtn=this.createControlButton('fas fa-chevron-left',()=>this.previousPage(),'Previous Page');const nextBtn=this.createControlButton('fas fa-chevron-right',()=>this.nextPage(),'Next Page');const pageInfo=document.createElement('span');pageInfo.id='pageInfo';pageInfo.style.cssText='color:#FFFFFF;font-weight:bold;white-space:nowrap;min-width:max-content;';pageInfo.textContent=this.getCurrentPageName();const progressInfo=document.createElement('span');progressInfo.id='progressInfo';progressInfo.style.cssText='color:#FFFFFF;font-weight:bold;white-space:nowrap;margin-left:1rem;';progressInfo.textContent=this.getProgressText();const playBtn=this.createControlButton('fas fa-play',()=>this.togglePlay(),'Play/Pause');playBtn.id='playButton';const autoScrollBtn=this.createControlButton('fas fa-scroll',()=>this.toggleAutoScroll(),'Toggle Auto Scroll');autoScrollBtn.id='autoScrollBtn';autoScrollBtn.style.backgroundColor=this.autoScroll?'#BB86FC':'#555555';const pencilBtn=this.createControlButton('fas fa-pencil-alt',()=>this.toggleDrawing(),'Drawing Tool');pencilBtn.id='pencilBtn';const eraserBtn=this.createControlButton('fas fa-eraser',()=>this.toggleEraser(),'Toggle Eraser');eraserBtn.id='eraserBtn';const blankPageBtn=this.createControlButton('fas fa-square',()=>this.toggleBlankPage(),'Toggle Blank Page');blankPageBtn.id='blankPageBtn';blankPageBtn.style.backgroundColor=this.isBlankPage?'#4CAF50':'#BB86FC';const speakBtn=this.createControlButton('fas fa-volume-up',()=>this.toggleSpeak(),'Toggle Speak');speakBtn.id='speakBtn';const laserBtn=this.createControlButton('fas fa-dot-circle',()=>this.toggleLaser(),'Toggle Laser Pointer');laserBtn.id='laserBtn';laserBtn.style.backgroundColor=this.isLaserActive?'#4CAF50':'#BB86FC';const timerBtn=this.createControlButton('fas fa-play',()=>this.toggleTimer(),'Start Timer');timerBtn.id='timerBtn';timerBtn.style.width='4rem';const notesBtn=this.createControlButton('fas fa-sticky-note',()=>this.toggleNotes(),'Toggle Notes');notesBtn.id='notesBtn';notesBtn.style.backgroundColor=this.isNotesOpen?'#4CAF50':'#BB86FC';const progressBar=this.createProgressBar();const exitBtn=this.createControlButton('fas fa-times',()=>this.exitPresentationMode(),'Exit Presentation');exitBtn.style.backgroundColor='#f44336';scrollContainer.appendChild(prevBtn);scrollContainer.appendChild(pageInfo);scrollContainer.appendChild(progressInfo);scrollContainer.appendChild(nextBtn);scrollContainer.appendChild(playBtn);scrollContainer.appendChild(autoScrollBtn);scrollContainer.appendChild(pencilBtn);scrollContainer.appendChild(eraserBtn);scrollContainer.appendChild(blankPageBtn);scrollContainer.appendChild(speakBtn);scrollContainer.appendChild(laserBtn);scrollContainer.appendChild(timerBtn);scrollContainer.appendChild(notesBtn);scrollContainer.appendChild(progressBar);scrollContainer.appendChild(exitBtn);bottomBar.appendChild(scrollContainer);document.getElementById('presentationContainer').appendChild(bottomBar)},createControlButton(iconClass,clickHandler,ariaLabel){const button=document.createElement('button');button.innerHTML=`<i class="${iconClass}"></i>`;button.setAttribute('aria-label',ariaLabel);button.style.cssText='background-color:#BB86FC;color:#000000;border:none;width:2.5rem;height:2.5rem;border-radius:0.3125rem;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:1rem;transition:all 0.3s ease;flex-shrink:0;';button.addEventListener('click',()=>{this.resetUITimer();clickHandler()});button.addEventListener('keydown',(e)=>{if(e.key==='Enter'||e.key===' '){e.preventDefault();this.resetUITimer();clickHandler()}});button.addEventListener('mouseenter',()=>{this.resetUITimer();if(button.style.backgroundColor!=='#f44336'){button.style.backgroundColor='#9C27B0'}});button.addEventListener('mouseleave',()=>{if(button.style.backgroundColor!=='#f44336'){button.style.backgroundColor='#BB86FC'}});button.addEventListener('touchstart',()=>{this.resetUITimer()});return button},createProgressBar(){const container=document.createElement('div');container.style.cssText='width:150px;height:10px;background-color:#555555;border-radius:5px;overflow:hidden;flex-shrink:0;';const bar=document.createElement('div');bar.id='progressBar';bar.style.cssText='height:100%;background-color:#BB86FC;transition:width 0.3s ease;';const currentIndex=pagesDataIframe.findIndex(p=>p.id===this.currentPageId);const progress=((currentIndex+1)/pagesDataIframe.length)*100;bar.style.width=`${progress}%`;container.appendChild(bar);return container},getCurrentPageName(){const page=pagesDataIframe.find(p=>p.id===this.currentPageId);return page?page.name:'Unknown'},getProgressText(){const currentIndex=pagesDataIframe.findIndex(p=>p.id===this.currentPageId);return`Slide ${currentIndex+1}/${pagesDataIframe.length}`},startPresentation(){const contentArea=document.getElementById('presentationContent');if(!contentArea)return;contentArea.innerHTML='<div id="canvasContainer" style="position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:1;"></div>';document.getElementById('canvasContainer').appendChild(this.canvas);if(!this.isBlankPage){this.displayCurrentElements()}else{this.showBlankPage()}this.updateProgressBar();this.updateNotes();this.scrollToTop();this.restoreTimerState()},displayCurrentElements(){const contentArea=document.getElementById('presentationContent');if(!contentArea)return;const existingContent=contentArea.querySelector('#presentationElements');if(existingContent)existingContent.remove();const elementsContainer=document.createElement('div');elementsContainer.id='presentationElements';elementsContainer.style.cssText='position:relative;z-index:0;color:#FFFFFF;line-height:1.6;word-wrap:break-word;overflow-wrap:break-word;';elementsContainer.innerHTML=`<style>#presentationElements *{max-width:100% !important;box-sizing:border-box;}#presentationElements h1,#presentationElements h2,#presentationElements h3{color:#BB86FC;margin-bottom:1rem;}#presentationElements p{margin-bottom:1rem;}#presentationElements pre{background-color:#0a0a0a;padding:1rem;border-radius:0.3125rem;margin-bottom:1rem;overflow-x:auto;max-width:100%;}#presentationElements table{width:100%;border-collapse:collapse;margin-bottom:1rem;table-layout:fixed;}#presentationElements th,#presentationElements td{border:1px solid #555555;padding:0.5rem;text-align:left;word-wrap:break-word;}#presentationElements th{background-color:#2a2a2a;color:#BB86FC;}#presentationElements ul,#presentationElements ol{margin:0 0 1rem 1.25rem;padding:0;}#presentationElements li{margin-bottom:0.5rem;padding-left:0.5rem;}#presentationElements ul li{list-style-type:disc;}#presentationElements ol li{list-style-type:decimal;}#presentationElements blockquote{margin:1rem 0;padding:1rem;border-left:4px solid #BB86FC;background-color:#0a0a0a;}#presentationElements strong{color:#BB86FC;font-weight:bold;}#presentationElements em{color:#96CEB4;font-style:italic;}#presentationElements code{background-color:#2a2a2a;padding:0.2rem 0.4rem;border-radius:0.2rem;font-family:"Courier New",monospace;}#presentationElements img{max-width:80% !important;height:auto !important;max-height:400px !important;border-radius:0.3125rem;margin-bottom:1rem;object-fit:contain;display:block;margin-left:auto;margin-right:auto;}#presentationElements iframe{width:80% !important;height:300px;max-height:400px;border:none;border-radius:0.3125rem;margin-bottom:1rem;display:block;margin-left:auto;margin-right:auto;}#presentationElements .formula-block-iframe{overflow-x:auto;padding:1rem;background-color:#0a0a0a;border:1px solid #BB86FC;border-radius:0.3125rem;margin-bottom:1rem;}#presentationElements .qa-block{background-color:#0a0a0a;border:1px solid #BB86FC;border-radius:0.3125rem;padding:1rem;margin-bottom:1rem;}#presentationElements a{color:#BB86FC;text-decoration:underline;word-break:break-all;}#presentationElements .typing-element{border-right:2px solid #BB86FC;animation:blink 1s infinite;}@keyframes blink{0%,50%{border-color:#BB86FC;}51%,100%{border-color:transparent;}}</style>`;for(let i=0;i<=this.currentElementIndex&&i<this.elements.length;i++){if(i===this.currentElementIndex&&this.isTyping){const tempDiv=document.createElement('div');tempDiv.innerHTML=this.elements[i];const element=tempDiv.firstElementChild;if(element&&(element.tagName==='P'||element.tagName.startsWith('H'))){const typingElement=element.cloneNode(false);typingElement.classList.add('typing-element');typingElement.textContent=element.textContent.substring(0,this.currentTypingIndex);elementsContainer.appendChild(typingElement)}else{elementsContainer.innerHTML+=this.elements[i]}}else{elementsContainer.innerHTML+=this.elements[i]}}contentArea.appendChild(elementsContainer);setTimeout(()=>{this.resizeCanvas();if(typeof MathJax!=='undefined'){MathJax.typesetPromise([elementsContainer]).catch(err=>{})}if(typeof hljs!=='undefined'){elementsContainer.querySelectorAll('pre code').forEach(block=>hljs.highlightElement(block))}if(this.autoScroll)this.scrollToBottom();else this.scrollToTop()},100)},scrollToTop(){const contentArea=document.getElementById('presentationContent');if(contentArea)contentArea.scrollTop=0},scrollToBottom(){const contentArea=document.getElementById('presentationContent');if(contentArea)contentArea.scrollTop=contentArea.scrollHeight},typeNextCharacter(){if(!this.isTyping||this.currentElementIndex>=this.elements.length)return;const tempDiv=document.createElement('div');tempDiv.innerHTML=this.elements[this.currentElementIndex];const element=tempDiv.firstElementChild;if(element&&(element.tagName==='P'||element.tagName.startsWith('H'))){const fullText=element.textContent;if(this.currentTypingIndex<fullText.length){this.currentTypingIndex++;this.displayCurrentElements();setTimeout(()=>this.typeNextCharacter(),this.typingSpeed)}else{this.isTyping=false;this.currentTypingIndex=0;const typingElement=document.querySelector('.typing-element');if(typingElement){typingElement.classList.remove('typing-element')}}}else{this.isTyping=false;this.currentTypingIndex=0}},togglePlay(){this.isPlaying=!this.isPlaying;const playBtn=document.getElementById('playButton');if(this.currentElementIndex>=this.elements.length){this.currentElementIndex=0;this.isPlaying=true;this.displayCurrentElements()}playBtn.innerHTML=this.isPlaying?'<i class="fas fa-pause"></i>':(this.currentElementIndex>=this.elements.length?'<i class="fas fa-redo"></i>':'<i class="fas fa-play"></i>');playBtn.setAttribute('aria-label',this.isPlaying?'Pause':(this.currentElementIndex>=this.elements.length?'Restart Page':'Play'));if(this.isPlaying){this.nextElement()}else{if(this.playInterval){clearInterval(this.playInterval);this.playInterval=null}this.isTyping=false}this.savePageState()},nextElement(){if(this.currentElementIndex<this.elements.length-1){this.currentElementIndex++;const tempDiv=document.createElement('div');tempDiv.innerHTML=this.elements[this.currentElementIndex];const element=tempDiv.firstElementChild;if(element&&(element.tagName==='P'||element.tagName.startsWith('H'))){this.isTyping=true;this.currentTypingIndex=0;this.displayCurrentElements();this.typeNextCharacter();this.playInterval=setTimeout(()=>{if(this.isPlaying)this.nextElement()},element.textContent.length*this.typingSpeed+1000)}else{this.displayCurrentElements();this.playInterval=setTimeout(()=>{if(this.isPlaying)this.nextElement()},2000)}}else{this.isPlaying=false;if(this.playInterval){clearInterval(this.playInterval);this.playInterval=null}const playBtn=document.getElementById('playButton');playBtn.innerHTML='<i class="fas fa-redo"></i>';playBtn.setAttribute('aria-label','Restart Page')}this.savePageState()},toggleAutoScroll(){this.autoScroll=!this.autoScroll;const btn=document.getElementById('autoScrollBtn');btn.style.backgroundColor=this.autoScroll?'#BB86FC':'#555555';btn.setAttribute('aria-label',this.autoScroll?'Auto Scroll On':'Auto Scroll Off');if(this.autoScroll)this.scrollToBottom();else this.scrollToTop()},toggleDrawing(){const isDrawingEnabled=this.canvas.style.pointerEvents==='auto'&&this.ctx.strokeStyle==='#BB86FC'&&this.ctx.globalCompositeOperation==='source-over';this.canvas.style.pointerEvents=isDrawingEnabled?'none':'auto';const btn=document.getElementById('pencilBtn');btn.style.backgroundColor=isDrawingEnabled?'#BB86FC':'#4CAF50';btn.setAttribute('aria-label',isDrawingEnabled?'Enable Drawing':'Disable Drawing');this.ctx.strokeStyle='#BB86FC';this.ctx.globalCompositeOperation='source-over';if(this.eraserMode)this.toggleEraser();if(this.isLaserActive)this.toggleLaser()},clearCanvas(){if(this.ctx&&this.canvas)this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height)},setupUIAutoHide(){this.resetUITimer();const container=document.getElementById('presentationContainer');if(container){container.addEventListener('mousemove',()=>this.resetUITimer());container.addEventListener('click',()=>this.resetUITimer());container.addEventListener('keydown',()=>this.resetUITimer());container.addEventListener('touchstart',()=>this.resetUITimer())}},resetUITimer(){this.lastInteraction=Date.now();if(this.uiTimeout)clearTimeout(this.uiTimeout);this.showUI();this.uiTimeout=setTimeout(()=>this.fadeUI(),60000)},showUI(){const bottomBar=document.getElementById('presentationBottomBar');if(bottomBar){bottomBar.style.opacity='1';bottomBar.style.pointerEvents='auto'}this.isUIHidden=false},fadeUI(){const bottomBar=document.getElementById('presentationBottomBar');if(bottomBar){bottomBar.style.opacity='0.7';if(this.uiTimeout)clearTimeout(this.uiTimeout);this.uiTimeout=setTimeout(()=>this.hideUI(),120000)}},hideUI(){const bottomBar=document.getElementById('presentationBottomBar');if(bottomBar){bottomBar.style.opacity='0';bottomBar.style.pointerEvents='none'}this.isUIHidden=true;this.createMinimizedButton()},setupMainButtonAutoHide(){this.resetMainButtonTimer();document.addEventListener('mousemove',()=>this.resetMainButtonTimer());document.addEventListener('click',()=>this.resetMainButtonTimer());document.addEventListener('keydown',()=>this.resetMainButtonTimer());document.addEventListener('touchstart',()=>this.resetMainButtonTimer())},resetMainButtonTimer(){this.lastInteraction=Date.now();if(this.mainButtonTimeout)clearTimeout(this.mainButtonTimeout);this.showMainButton();this.mainButtonTimeout=setTimeout(()=>this.fadeMainButton(),5000)},showMainButton(){const button=document.getElementById('presentationModeBtn');if(button&&!this.isActive){button.style.opacity='1';button.style.pointerEvents='auto'}this.isMainButtonHidden=false},fadeMainButton(){const button=document.getElementById('presentationModeBtn');if(button&&!this.isActive){button.style.opacity='0.7';if(this.mainButtonTimeout)clearTimeout(this.mainButtonTimeout);this.mainButtonTimeout=setTimeout(()=>this.hideMainButton(),5000)}},hideMainButton(){const button=document.getElementById('presentationModeBtn');if(button&&!this.isActive){button.style.opacity='0';button.style.pointerEvents='none'}this.isMainButtonHidden=true;this.createMainMinimizedButton()},createMainMinimizedButton(){if(document.getElementById('mainMinimizedBtn')||this.isActive)return;const button=document.createElement('button');button.id='mainMinimizedBtn';button.innerHTML='<i class="fas fa-play"></i>';button.setAttribute('aria-label','Start Presentation (P)');button.style.cssText='position:fixed;top:5rem;right:0.2rem;background-color:#BB86FC;color:#000000;border:none;width:1rem;height:1rem;border-radius:0.2rem;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:0.5rem;opacity:0.4;z-index:1001;transition:opacity 0.3s ease;';button.addEventListener('click',()=>{this.resetMainButtonTimer();button.remove();this.togglePresentationMode()});button.addEventListener('mouseenter',()=>button.style.opacity='0.8');button.addEventListener('mouseleave',()=>button.style.opacity='0.4');button.addEventListener('touchstart',()=>{button.style.opacity='0.8'});button.addEventListener('touchend',()=>{button.style.opacity='0.4'});document.body.appendChild(button)},setupGlobalKeyboardShortcuts(){document.addEventListener('keydown',(e)=>{if(this.isActive)return;if(e.key==='p'||e.key==='P'){if(!e.ctrlKey&&!e.altKey&&!e.metaKey){e.preventDefault();this.resetMainButtonTimer();this.togglePresentationMode()}}})},setupPresentationKeyboardShortcuts(){const container=document.getElementById('presentationContainer');if(!container)return;container.addEventListener('keydown',(e)=>{this.resetUITimer();switch(e.key){case'Escape':this.exitPresentationMode();break;case' ':case'k':case'K':e.preventDefault();this.togglePlay();break;case'ArrowRight':case'j':case'J':e.preventDefault();if(this.currentElementIndex<this.elements.length-1){this.currentElementIndex++;this.displayCurrentElements()};break;case'ArrowLeft':case'h':case'H':e.preventDefault();if(this.currentElementIndex>0){this.currentElementIndex--;this.displayCurrentElements()};break;case'ArrowUp':case'PageUp':e.preventDefault();this.previousPage();break;case'ArrowDown':case'PageDown':e.preventDefault();this.nextPage();break;case'Home':e.preventDefault();this.currentElementIndex=0;this.displayCurrentElements();break;case'End':e.preventDefault();this.currentElementIndex=this.elements.length-1;this.displayCurrentElements();break;case'd':case'D':e.preventDefault();this.toggleDrawing();break;case'e':case'E':e.preventDefault();this.toggleEraser();break;case'c':case'C':e.preventDefault();this.clearCanvas();break;case's':case'S':e.preventDefault();this.toggleAutoScroll();break;case'f':case'F':e.preventDefault();if(document.fullscreenElement){document.exitFullscreen()}else{container.requestFullscreen()};break;case'b':case'B':e.preventDefault();this.toggleBlankPage();break;case't':case'T':e.preventDefault();this.toggleSpeak();break;case'n':case'N':e.preventDefault();this.toggleNotes();break;case'l':case'L':e.preventDefault();this.toggleLaser();break;case'r':case'R':e.preventDefault();this.toggleTimer();break;case'?':case'h':case'H':e.preventDefault();this.showKeyboardHelp();break}})},showKeyboardHelp(){const helpDiv=document.getElementById('keyboardHelp');if(helpDiv){helpDiv.remove();return}const help=document.createElement('div');help.id='keyboardHelp';help.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background-color:#0a0a0a;border:2px solid #BB86FC;border-radius:0.5rem;padding:2rem;z-index:10003;color:#FFFFFF;max-width:90vw;max-height:90vh;overflow-y:auto;';help.innerHTML=`<h3 style="color:#BB86FC;margin-top:0;">Keyboard Shortcuts</h3><div style="columns:2;column-gap:2rem;line-height:1.8;"><div><strong>Space/K:</strong> Play/Pause/Restart</div><div><strong>→/J:</strong> Next Element</div><div><strong>←/H:</strong> Previous Element</div><div><strong>↑/PgUp:</strong> Previous Page</div><div><strong>↓/PgDn:</strong> Next Page</div><div><strong>Home:</strong> First Element</div><div><strong>End:</strong> Last Element</div><div><strong>D:</strong> Toggle Drawing</div><div><strong>E:</strong> Toggle Eraser</div><div><strong>C:</strong> Clear Canvas</div><div><strong>S:</strong> Toggle Auto Scroll</div><div><strong>F:</strong> Toggle Fullscreen</div><div><strong>B:</strong> Toggle Blank Page</div><div><strong>T:</strong> Toggle Speak</div><div><strong>N:</strong> Toggle Notes</div><div><strong>L:</strong> Toggle Laser Pointer</div><div><strong>R:</strong> Start/Pause/Resume/Reset Timer</div><div><strong>P:</strong> Start Presentation (Global)</div><div><strong>Esc:</strong> Exit Presentation</div><div><strong>?/H:</strong> Show/Hide Help</div></div><p style="text-align:center;margin-top:1.5rem;"><button onclick="this.parentElement.parentElement.remove()" style="background-color:#BB86FC;color:#000;border:none;padding:0.5rem 1rem;border-radius:0.25rem;cursor:pointer;">Close</button></p>`;document.getElementById('presentationContainer').appendChild(help);setTimeout(()=>help.remove(),8000)},createMinimizedButton(){if(document.getElementById('minimizedControlBtn'))return;const button=document.createElement('button');button.id='minimizedControlBtn';button.innerHTML='<i class="fas fa-chevron-up"></i>';button.setAttribute('aria-label','Show Controls');button.style.cssText='position:fixed;bottom:0.5rem;right:0.5rem;background-color:#BB86FC;color:#000000;border:none;width:1.5rem;height:1.5rem;border-radius:0.2rem;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:0.7rem;opacity:0.5;z-index:10002;transition:opacity 0.3s ease;';button.addEventListener('click',()=>{this.resetUITimer();button.remove()});button.addEventListener('mouseenter',()=>button.style.opacity='0.8');button.addEventListener('mouseleave',()=>button.style.opacity='0.5');button.addEventListener('touchstart',()=>{button.style.opacity='0.8'});button.addEventListener('touchend',()=>{button.style.opacity='0.5'});document.getElementById('presentationContainer').appendChild(button)},toggleEraser(){this.eraserMode=!this.eraserMode;const eraserBtn=document.getElementById('eraserBtn');const pencilBtn=document.getElementById('pencilBtn');if(this.eraserMode){eraserBtn.style.backgroundColor='#f44336';pencilBtn.style.backgroundColor='#555555';this.canvas.style.cursor='crosshair';if(this.isLaserActive)this.toggleLaser()}else{eraserBtn.style.backgroundColor='#BB86FC';pencilBtn.style.backgroundColor='#BB86FC';this.canvas.style.cursor=this.isLaserActive?'none':'default'};this.ctx.globalCompositeOperation=this.eraserMode?'destination-out':'source-over';this.ctx.strokeStyle='#BB86FC'},previousPage(){this.savePageState();const currentIndex=pagesDataIframe.findIndex(p=>p.id===this.currentPageId);if(currentIndex>0){this.currentPageId=pagesDataIframe[currentIndex-1].id;this.isBlankPage=false;this.extractElements();this.startPresentation();document.getElementById('pageInfo').textContent=this.getCurrentPageName();document.getElementById('progressInfo').textContent=this.getProgressText();this.updateProgressBar();this.updateNotes()}},nextPage(){this.savePageState();const currentIndex=pagesDataIframe.findIndex(p=>p.id===this.currentPageId);if(currentIndex<pagesDataIframe.length-1){this.currentPageId=pagesDataIframe[currentIndex+1].id;this.isBlankPage=false;this.extractElements();this.startPresentation();document.getElementById('pageInfo').textContent=this.getCurrentPageName();document.getElementById('progressInfo').textContent=this.getProgressText();this.updateProgressBar();this.updateNotes()}},toggleBlankPage(){this.isBlankPage=!this.isBlankPage;const blankPageBtn=document.getElementById('blankPageBtn');blankPageBtn.style.backgroundColor=this.isBlankPage?'#4CAF50':'#BB86FC';blankPageBtn.setAttribute('aria-label',this.isBlankPage?'Disable Blank Page':'Enable Blank Page');this.canvas.style.pointerEvents=this.isBlankPage||this.isDrawing||this.isLaserActive?'auto':'none';this.clearCanvas();if(this.isBlankPage){this.showBlankPage()}else{this.displayCurrentElements()}},showBlankPage(){const contentArea=document.getElementById('presentationContent');if(!contentArea)return;const existingContent=contentArea.querySelector('#presentationElements');if(existingContent)existingContent.remove();const blankContainer=document.createElement('div');blankContainer.id='blankPage';blankContainer.style.cssText='position:relative;width:100%;height:100%;background-color:#1a1a1a;z-index:0;';contentArea.appendChild(blankContainer);this.resizeCanvas();this.canvas.style.pointerEvents='auto';this.scrollToTop()},toggleSpeak(){this.isSpeaking=!this.isSpeaking;const speakBtn=document.getElementById('speakBtn');speakBtn.innerHTML=this.isSpeaking?'<i class="fas fa-pause"></i>':'<i class="fas fa-volume-up"></i>';speakBtn.setAttribute('aria-label',this.isSpeaking?'Pause Speech':'Start Speech');if(this.isSpeaking){this.startSpeaking()}else{this.speechSynthesis.cancel();this.currentSpeech=null}},startSpeaking(){if(!this.speechSynthesis){alert('Text-to-speech is not supported in this browser.');this.isSpeaking=false;const speakBtn=document.getElementById('speakBtn');speakBtn.innerHTML='<i class="fas fa-volume-up"></i>';speakBtn.setAttribute('aria-label','Start Speech');return}this.speechSynthesis.cancel();const tempDiv=document.createElement('div');tempDiv.innerHTML=this.elements[this.currentElementIndex]||'';const element=tempDiv.firstElementChild;const text=element?element.textContent:'';if(!text){this.isSpeaking=false;const speakBtn=document.getElementById('speakBtn');speakBtn.innerHTML='<i class="fas fa-volume-up"></i>';speakBtn.setAttribute('aria-label','Start Speech');return}this.currentSpeech=new SpeechSynthesisUtterance(text);const voices=this.speechSynthesis.getVoices();const bestVoice=voices.find(voice=>voice.lang.startsWith('en'))||voices[0];this.currentSpeech.voice=bestVoice;this.currentSpeech.rate=1;this.currentSpeech.pitch=1;this.currentSpeech.onend=()=>{this.isSpeaking=false;const speakBtn=document.getElementById('speakBtn');speakBtn.innerHTML='<i class="fas fa-volume-up"></i>';speakBtn.setAttribute('aria-label','Start Speech');if(this.currentElementIndex<this.elements.length-1){this.currentElementIndex++;this.displayCurrentElements();this.startSpeaking()}};this.speechSynthesis.speak(this.currentSpeech)},setupTimerButton(){const timerBtn=document.getElementById('timerBtn');if(!timerBtn)return;let hoverTimeout=null;this.updateTimerButton();timerBtn.addEventListener('mouseenter',()=>{this.resetUITimer();if(this.timerState==='paused'){hoverTimeout=setTimeout(()=>{this.timerState='reset';this.updateTimerButton()},2000)}});timerBtn.addEventListener('mouseleave',()=>{clearTimeout(hoverTimeout);if(this.timerState==='reset'){this.timerState='paused';this.updateTimerButton()}});timerBtn.addEventListener('touchstart',(e)=>{this.resetUITimer();if(this.timerState==='paused'){hoverTimeout=setTimeout(()=>{this.timerState='reset';this.updateTimerButton()},2000);e.preventDefault()}});timerBtn.addEventListener('touchend',()=>{clearTimeout(hoverTimeout);if(this.timerState==='reset'){this.timerState='paused';this.updateTimerButton()}})},toggleTimer(){if(this.timerState==='stopped'){this.timerState='running';this.timerStart=Date.now()-this.timerElapsed*1000;this.startTimer()}else if(this.timerState==='running'){this.timerState='paused';if(this.timerInterval)clearInterval(this.timerInterval);this.timerInterval=null}else if(this.timerState==='paused'){this.timerState='running';this.timerStart=Date.now()-this.timerElapsed*1000;this.startTimer()}else if(this.timerState==='reset'){this.timerState='stopped';this.timerElapsed=0;if(this.timerInterval)clearInterval(this.timerInterval);this.timerInterval=null}this.updateTimerButton();this.savePageState()},startTimer(){if(this.timerInterval)clearInterval(this.timerInterval);this.timerInterval=setInterval(()=>{this.timerElapsed=Math.floor((Date.now()-this.timerStart)/1000);this.updateTimerButton()},1000)},updateTimerButton(){const timerBtn=document.getElementById('timerBtn');if(!timerBtn)return;const minutes=Math.floor(this.timerElapsed/60).toString().padStart(2,'0');const seconds=(this.timerElapsed%60).toString().padStart(2,'0');const timeText=`${minutes}:${seconds}`;let icon,label;if(this.timerState==='stopped'){icon='fa-play';label='Start Timer'}else if(this.timerState==='running'){icon='fa-pause';label=`Pause Timer (${timeText})`}else if(this.timerState==='paused'){icon='fa-play';label=`Resume Timer (${timeText})`}else if(this.timerState==='reset'){icon='fa-redo';label=`Reset Timer (${timeText})`}timerBtn.innerHTML=`<i class="fas ${icon}"></i> ${timeText}`;timerBtn.setAttribute('aria-label',label)},savePageState(){this.pageStates[this.currentPageId]={elementIndex:this.currentElementIndex,isPlaying:this.isPlaying,timerState:this.timerState,timerElapsed:this.timerElapsed}},loadPageState(){const state=this.pageStates[this.currentPageId]||{};this.currentElementIndex=state.elementIndex||0;this.isPlaying=state.isPlaying||false;this.timerState=state.timerState||'stopped';this.timerElapsed=state.timerElapsed||0},restoreTimerState(){if(this.timerState==='running'){this.timerStart=Date.now()-this.timerElapsed*1000;this.startTimer()}this.updateTimerButton()},handleLaser(e){if(!this.canvas||!this.ctx||!e)return;const rect=this.canvas.getBoundingClientRect();const x=e.clientX-rect.left;const y=e.clientY-rect.top;if(x<0||y<0||x>this.canvas.width/window.devicePixelRatio||y>this.canvas.height/window.devicePixelRatio)return;this.clearCanvas();this.ctx.beginPath();this.ctx.arc(x,y,5,0,2*Math.PI);this.ctx.fillStyle='#FF0000';this.ctx.fill()},handleLaserTouch(e){if(!this.canvas||!this.ctx||!e.touches||!e.touches[0])return;e.preventDefault();const rect=this.canvas.getBoundingClientRect();const x=e.touches[0].clientX-rect.left;const y=e.touches[0].clientY-rect.top;if(x<0||y<0||x>this.canvas.width/window.devicePixelRatio||y>this.canvas.height/window.devicePixelRatio)return;this.clearCanvas();this.ctx.beginPath();this.ctx.arc(x,y,5,0,2*Math.PI);this.ctx.fillStyle='#FF0000';this.ctx.fill()},toggleLaser(){this.isLaserActive=!this.isLaserActive;const laserBtn=document.getElementById('laserBtn');if(laserBtn){laserBtn.style.backgroundColor=this.isLaserActive?'#4CAF50':'#BB86FC';laserBtn.setAttribute('aria-label',this.isLaserActive?'Disable Laser Pointer':'Enable Laser Pointer')}if(this.canvas){this.canvas.style.pointerEvents=this.isLaserActive||this.isDrawing||this.isBlankPage?'auto':'none';this.canvas.style.cursor=this.isLaserActive?'none':(this.eraserMode?'crosshair':'default')}if(this.isLaserActive){if(this.isDrawing)this.toggleDrawing();if(this.eraserMode)this.toggleEraser();this.canvas.addEventListener('mousemove',this.handleLaser.bind(this));this.canvas.addEventListener('touchmove',this.handleLaserTouch.bind(this));this.canvas.addEventListener('touchcancel',()=>{this.clearCanvas()})}else{if(this.canvas){this.canvas.removeEventListener('mousemove',this.handleLaser);this.canvas.removeEventListener('touchmove',this.handleLaserTouch);this.canvas.removeEventListener('touchcancel',this.clearCanvas)}this.clearCanvas()}},updateProgressBar(){const progressBar=document.getElementById('progressBar');if(progressBar){const currentIndex=pagesDataIframe.findIndex(p=>p.id===this.currentPageId);const progress=((currentIndex+1)/pagesDataIframe.length)*100;progressBar.style.width=`${progress}%`}},toggleNotes(){this.isNotesOpen=!this.isNotesOpen;const notesBtn=document.getElementById('notesBtn');if(notesBtn){notesBtn.style.backgroundColor=this.isNotesOpen?'#4CAF50':'#BB86FC';notesBtn.setAttribute('aria-label',this.isNotesOpen?'Hide Notes':'Show Notes')}if(this.isNotesOpen){this.showNotes()}else{const notesPanel=document.getElementById('notesPanel');if(notesPanel)notesPanel.remove()}},showNotes(){const existingPanel=document.getElementById('notesPanel');if(existingPanel)existingPanel.remove();const notesPanel=document.createElement('div');notesPanel.id='notesPanel';notesPanel.setAttribute('role','complementary');notesPanel.setAttribute('aria-label','Presenter Notes');notesPanel.style.cssText='position:fixed;bottom:4.5rem;right:1rem;width:300px;max-height:40vh;background-color:#0a0a0a;border:2px solid #BB86FC;border-radius:0.5rem;padding:1rem;z-index:10003;color:#FFFFFF;overflow-y:auto;';const textarea=document.createElement('textarea');textarea.style.cssText='width:100%;height:100%;background-color:transparent;color:#FFFFFF;border:none;resize:none;font-size:1rem;padding:0.5rem;';textarea.setAttribute('aria-label','Edit Notes for Current Slide');const page=pagesDataIframe.find(p=>p.id===this.currentPageId);textarea.value=page.notes||'';textarea.addEventListener('input',()=>{page.notes=textarea.value});notesPanel.appendChild(textarea);document.getElementById('presentationContainer').appendChild(notesPanel);textarea.focus()},updateNotes(){if(this.isNotesOpen){const notesPanel=document.getElementById('notesPanel');if(notesPanel){const textarea=notesPanel.querySelector('textarea');const page=pagesDataIframe.find(p=>p.id===this.currentPageId);textarea.value=page.notes||''}}}}
document.addEventListener('DOMContentLoaded',()=>{PresentationMode.init()})
